<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Договор</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Prata&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/styles.css">
</head>
<body>
  <div class="bg-orb orb-1"></div>
  <div class="bg-orb orb-2"></div>
  <div class="bg-orb orb-3"></div>

  <main class="container" style="padding: 120px 0;">
    <a class="page-back" href="/">← На главную</a>

    <section class="panel">
      <div class="admin-section-head">
        <h1 class="section-title">Договор обучения</h1>
        <div class="admin-section-actions">
          <span class="admin-status {{ contract_status_class }}">{{ contract_status_label }}</span>
        </div>
      </div>
      <ul class="admin-list">
        <li><span>Курс</span><strong>{{ agreement.course or "—" }}</strong></li>
        <li><span>Участник</span><strong>{{ agreement.full_name or agreement.user.name or "—" }}</strong></li>
        <li><span>Канал отправки</span><strong>{{ contract_channel_label }}</strong></li>
      </ul>
      <div style="margin-top: 14px;">
        {% if contract_pdf_url %}
        <a class="btn btn-secondary" href="{{ contract_pdf_url }}" target="_blank" rel="noopener">Открыть PDF договора</a>
        {% else %}
        <a class="btn btn-secondary" href="/documents/dogovor.html" target="_blank" rel="noopener">Открыть договор</a>
        {% endif %}
      </div>
    </section>

    <section class="panel" style="margin-top: 24px;">
      <div class="admin-section-head">
        <h2 class="section-title">Данные для договора</h2>
        <div class="admin-section-actions">
          <span class="admin-badge">№ {{ contract_number }}</span>
          <span class="admin-badge">{{ contract_date }}</span>
          {% if contract_pdf_url %}
          <a class="btn btn-secondary" href="{{ contract_pdf_url }}" target="_blank" rel="noopener">Скачать PDF</a>
          {% endif %}
        </div>
      </div>
      <form class="admin-filter" method="post" action="/contract/{{ agreement.contract_token }}/save">
        <div class="admin-filter__row">
          <div class="input-wrap">
            <label class="auth-label">Город</label>
            <input type="text" name="city" value="{{ contract_fields.city }}" required>
          </div>
          <div class="input-wrap">
            <label class="auth-label">ФИО заказчика</label>
            <input type="text" name="customer_name" value="{{ contract_fields.customer_name }}" required>
          </div>
        </div>
        <div class="admin-filter__row">
          <div class="input-wrap">
            <label class="auth-label">Паспорт</label>
            <input type="text" name="customer_passport" value="{{ contract_fields.customer_passport }}" required>
          </div>
          <div class="input-wrap">
            <label class="auth-label">Адрес</label>
            <input type="text" name="customer_address" value="{{ contract_fields.customer_address }}" required>
          </div>
        </div>
        <div class="admin-filter__row">
          <div class="input-wrap">
            <label class="auth-label">Телефон</label>
            <input type="text" name="customer_phone" value="{{ contract_fields.customer_phone }}" required>
          </div>
          <div class="input-wrap">
            <label class="auth-label">Email</label>
            <input type="email" name="customer_email" value="{{ contract_fields.customer_email }}" required>
          </div>
        </div>
        <div class="admin-filter__actions">
          <button class="btn btn-primary" type="submit">Сохранить данные</button>
        </div>
      </form>
      <div class="admin-subtext" style="margin-top: 8px;">
        Дата договора заполняется автоматически по МСК при подписании.
      </div>
    </section>

    {% if message %}
    <section class="card" style="margin-top: 18px;">
      <strong>{{ message }}</strong>
    </section>
    {% endif %}
    {% if error %}
    <section class="card" style="margin-top: 18px; border-color: rgba(255, 77, 77, 0.4);">
      <strong>{{ error }}</strong>
    </section>
    {% endif %}

    <section class="panel" style="margin-top: 24px;">
      <div class="admin-section-head">
        <h2 class="section-title">Отправить договор</h2>
      </div>
      <form class="admin-filter" method="post" action="/contract/{{ agreement.contract_token }}/send">
        <div class="admin-filter__row">
          <div class="input-wrap">
            <label class="auth-label">Канал</label>
            <select name="channel">
              {% for item in channels %}
              <option value="{{ item.key }}" {% if item.key == default_channel %}selected{% endif %} {% if item.disabled %}disabled{% endif %}>
                {{ item.label }}{% if item.detail %} · {{ item.detail }}{% endif %}{% if item.note %} ({{ item.note }}){% endif %}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="input-wrap">
            <label class="auth-label">Email для отправки</label>
            <input type="email" name="email" placeholder="name@example.com" value="{{ manual_email }}">
          </div>
        </div>
        <div class="admin-filter__actions">
          <button class="btn btn-primary" type="submit">Отправить договор</button>
        </div>
      </form>
      <div class="admin-subtext" style="margin-top: 8px;">
        Если отправка в VK недоступна, укажите email вручную.
      </div>
    </section>

    {% if contract_status_key != "signed" %}
    <section class="panel" style="margin-top: 24px;">
      <div class="admin-section-head">
        <h2 class="section-title">Подтверждение</h2>
      </div>
      <form method="post" action="/contract/{{ agreement.contract_token }}/sign">
        <button class="btn btn-secondary" type="submit">Подписать и сформировать PDF</button>
      </form>
    </section>
    {% endif %}
  </main>
</body>
</html>
